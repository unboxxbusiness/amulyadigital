rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // Admins and sub-admins can read/write any user document
      allow read, write: if request.auth.token.role in ['admin', 'sub-admin'];
      // A user can read/write their own document
      allow read, write: if request.auth.uid == userId;
    }

    match /counters/{counterId} {
        // Only admins/sub-admins (server-side) can read/write to counters
        allow read, write: if request.auth.token.role in ['admin', 'sub-admin'];
    }

    match /serviceRequests/{requestId} {
        // A user can create a service request for themselves
        allow create: if request.auth.uid != null && request.resource.data.memberId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.memberId;
        // A user can read their own service requests
        allow read: if request.auth.uid != null && get(/databases/$(database)/documents/serviceRequests/$(requestId)).data.memberId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.memberId;
        // Admins and sub-admins can read and update any service request
        allow read, update: if request.auth.token.role in ['admin', 'sub-admin'];
    }
  }
}
